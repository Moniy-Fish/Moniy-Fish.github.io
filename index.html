<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fl0ey - Fl0ey</title><meta name="author" content="Fl0ey"><meta name="copyright" content="Fl0ey"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="pwner">
<meta property="og:type" content="website">
<meta property="og:title" content="Fl0ey">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Fl0ey">
<meta property="og:description" content="pwner">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/vn_pwn_simpleHeap92de66ab35ad1d659fae887a6e07e13d_1.jpg">
<meta property="article:author" content="Fl0ey">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/vn_pwn_simpleHeap92de66ab35ad1d659fae887a6e07e13d_1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: false,
  isHome: true,
  isHighlightShrink: undefined,
  isSidebar: false,
  postUpdate: '2020-12-08 21:51:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/vn_pwn_simpleHeap92de66ab35ad1d659fae887a6e07e13d_1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">13</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg"></div><header class="full_page" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208171528.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Fl0ey</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="site-info"><h1 id="site-title">Fl0ey</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://github.com/Moniy-Fish" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2549897388@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout_page" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left_radius"><a href="/2020/12/07/12-7/" title="ROACTF_2a1">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165411.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ROACTF_2a1"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/12/07/12-7/" title="ROACTF_2a1">ROACTF_2a1</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-12-07T14:27:33.000Z" title="发表于 2020-12-07 22:27:33">2020-12-07</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/write-up/">write_up</a></span></div><div class="content">前言ROACTF一道题，劫持方式有点特别，调试的时候也发现劫持link_map结构体能够做到劫持程序流回到main函数之类的，特此记录一下调试过程
解题思路64位的，保护全开
给出libc，存在任意地址泄露8字节，并且能够任意地址写入一个堆地址，堆内容可控
因为没有其他的骚操作，所以关键是在__libc_start_main中调用的exit()函数

首先程序开启了NX，在堆里写shellcode并将堆地址写入_rtld_global结构体里的_dl_rtld_lock_recursive是行不通的

其次题目给的堆块太小了，我们没办法伪造fake_chunk而后劫持_IO_all_list，并且因为太小了，我们劫持IO的vtable也无法将_IO_new_file_setbuf改为one_gadget


在阅读_dl_fini源码，我发现两处可以劫持的地方，这就是我最初的思路(虽然行不通)，接下来讲讲调试过程
调试过程首先_dl_fini有一块很有意思的地方
123456789#define	DT_FINI_ARRAY	26if (l-&gt;l_info[DT_FINI_ARRA ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/2020/11/29/NCTF2020/" title="NCTF2020">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208191236.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="NCTF2020"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/11/29/NCTF2020/" title="NCTF2020">NCTF2020</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-11-29T13:26:24.000Z" title="发表于 2020-11-29 21:26:24">2020-11-29</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/write-up/">write_up</a></span></div><div class="content">前言NCTF的题目质量都很高，故记录一下调试分析
bruteforce解题思路:查保护，未开PIE，got表可写

只有三个功能:add、edit、delete
add:只能开辟0x30大小的堆，堆地址存储在0x4040B0
edit:能编辑堆内容，存在UAF
delete:free后未置零
虽然是UAF，但是因为限制我们仅能释放一个堆块到fastbin中，而got表头处0x404000存放了地址0x403e20，而我们的chunk的大小固定为0x40，所以我们考虑利用UAF，在got表头处开堆，而后劫持got表中的free，将其改为printf的plt表，而got表头开堆处我们写入一个格式化字符串，这样就当我们调用free的时候就会泄露基地址，得到libc后将free劫持为system，而写入的格式化字符串改为”/bin/sh”即可拿到shell
调试过程:首先确定我们在got表头开堆的位置:

然后写入格式化字符串和printf的plt表
123456add()delete()edit(p64(0x403ffa))add()add()edit(&quot;%17$p&quot;+& ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/2020/11/20/HouseOfMuney/" title="House_of_Muney">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208191051.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="House_of_Muney"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/11/20/HouseOfMuney/" title="House_of_Muney">House_of_Muney</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-11-20T07:44:24.000Z" title="发表于 2020-11-20 15:44:24">2020-11-20</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/%E5%A4%8D%E7%8E%B0/">复现</a></span></div><div class="content">前言:看到大佬博客有一篇关于House_Of_Muney的介绍，觉得挺新奇的，故尝试分析原理。
博客链接：https://maxwelldulin.com/BlogPost?post=6967456768
POC：https://github.com/mdulin2/house-of-muney
关于动态链接库:从Github上clone的POC要使用里面给的libc版本，而且作者也给了修改动态链接库的脚本，不过我本地却有问题，所以记录一下修改动态链接库。
首先把2.31文件夹里的libc-2.31.so改成libc.so.6
然后用patchelf工具，修改ELF文件的动态链接库
1patchelf --set-interpreter 2.31/ld-2.31.so --set-rpath 2.31 ./munmap_rewrite 

这样就能运行和调试了，按照作者给出的POC，直接运行是可以弹出shell的

调试分析:0x00先进行初始化操作
123456789clearenv(); // Need to not crash once the shell is popped o ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/2020/11/12/%E9%93%81%E4%B8%89pwnWriteup/" title="铁人三项线上赛pwn题">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208164539.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="铁人三项线上赛pwn题"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/11/12/%E9%93%81%E4%B8%89pwnWriteup/" title="铁人三项线上赛pwn题">铁人三项线上赛pwn题</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-11-12T11:37:34.000Z" title="发表于 2020-11-12 19:37:34">2020-11-12</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/write-up/">write_up</a></span></div><div class="content">1.namepie题目分析:除去GOT表可写，其他保护全开，存在两次栈溢出，有后门函数，第一次直接泄露出canary，第二次溢出覆盖返回地址低一个字节，覆盖为后门函数偏移
基本思路:存在两次输入，第一次可以覆盖掉canary的低一个字节，固定为”\x00”，这样通过printf函数可以将canary泄露出来

因为开启了PIE，泄露出了canary后，后续的栈溢出，我们只需要覆盖掉返回地址的低一个字节，覆盖为”\x71”
因为后门函数的偏移是a71，返回地址最后三个十六进制必为axx故我们只需覆盖成”\x71”即可


完整EXP:1234567891011121314151617from pwn import *context.log_level = &quot;debug&quot;#r=process(&quot;./namepie&quot;)r=remote(&quot;172.20.14.170&quot;,9999)payload=&quot;a&quot;*0x29r.sendafter(&quot;Name:&quot;,payload)#gdb.attach(r)r ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/2020/11/04/free%E6%80%9D%E8%B7%AF/" title="glibc-2.31下double free思路">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208164650.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="glibc-2.31下double free思路"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/11/04/free%E6%80%9D%E8%B7%AF/" title="glibc-2.31下double free思路">glibc-2.31下double free思路</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-11-04T07:53:09.000Z" title="发表于 2020-11-04 15:53:09">2020-11-04</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/pwn/">pwn</a></span></div><div class="content">前言在glibc-2.27到glibc-2.28，由于tcache机制没有加入检查机制，仅需要double free两次相同的堆块就可以形成环，我们利用tcache机制可以比fastbin attack更方便的地址任意写，因为它不像fastbin attack存在检查size
但是在glibc-2.29到glibc-2.31，tcache机制加入了检查机制，而tcache的stash机制能让glibc-2.29到glibc-2.31下的double free有一种新的姿势
Tcache检查首先在chunk中插入了指向所属tcache结构体的*key指针
123456typedef struct tcache_entry&#123;  struct tcache_entry *next;  //链表指针，对应chunk中的fd字段  /* This field exists to detect double frees.  */  struct tcache_perthread_struct *key;  //chunk的bk字段，指向所属的tcache结构体&#125; tcache_ ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/2020/10/27/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0(%E4%BA%8C)/" title="Linux内核学习(二)">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165115.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux内核学习(二)"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/10/27/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0(%E4%BA%8C)/" title="Linux内核学习(二)">Linux内核学习(二)</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-27T13:41:58.000Z" title="发表于 2020-10-27 21:41:58">2020-10-27</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/linux-kernel/">linux kernel</a></span></div><div class="content">内存寻址内存地址逻辑地址：包含在机器语言指令中用来指定一个操作数或者一个一条指令的地址称为逻辑地址。
逻辑地址由一个段和偏移量组成。
逻辑地址组成的两部分:段标识符(16位)、指定段内相对地址的偏移量(32位)
段标识符字段称为段选择符

段选择符字段:

线性地址:一个32位无符号整数，也称为虚拟地址，可表示高达4GB(2^30^*2^2^)的地址空间
物理地址:内存芯片级内存单元寻址，由32位或36位无符号整数表示，与从微处理器的地址引脚发送到内存总线上的电信号相对应
内存控制单元(MMU)**通过分段单元，将逻辑地址转化为线性地址，再通过分页单元将线性地址转化为物理地址**

分段寻址硬件分段段寄存器：为了能够快速找到段选择符，处理器提供段寄存器，段寄存器的唯一目的是存放段选择符。
有cs、ss、ds、es、fs、gs六个段寄存器

特别的，cs寄存器还有一个两位的字段，用来表明CPU当前特权级别，0为最高优先级，3为最低优先级；Linux下只用0级和3级，表示内核态和用户态
段描述符:每个段由一个8字节(64位)的段描述符表示
段描述符通常存放在GDT(全局描述符表)或LDT( ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/2020/10/26/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0(%E4%B8%80)/" title="Linux内核学习(一)">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165145.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux内核学习(一)"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/10/26/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0(%E4%B8%80)/" title="Linux内核学习(一)">Linux内核学习(一)</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-26T12:00:08.000Z" title="发表于 2020-10-26 20:00:08">2020-10-26</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/linux-kernel/">linux kernel</a></span></div><div class="content">内核源码树根目录描述


目录
含义描述



arch
特定体系结构的源码


block
块设备 I/O层


crypto
加密API


Documentation
内核源码文档


drivers
设备驱动程序


firmware
某些驱动程序需要的设备固件


fs
VFS和各种文件系统


include
内核头文件


init
内核引导和初始化


ipc
进程间通信代码


kernel
调度程序的核心子系统


lib
通用内核函数


LICENSES
内核相关的lincese文件


mm
内存管理子系统和VM


net
网络子系统


samples
示例，示范代码


scripts
编译内核所用的脚本


security
Linux 内核安全模块


sound
语音子系统


tools
在Linux开发中有用的工具


usr
早期用户空间代码


virt
虚拟化基础结构


编译内核配置内核1make config &#x2F;&#x2F;命令行界面，不建议使用

1make menuconfig &#x2F;&#x2F;图形界面

1ma ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/2020/10/15/house_of_orange/" title="House_of_Orange">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165230.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="House_of_Orange"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/10/15/house_of_orange/" title="House_of_Orange">House_of_Orange</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-15T14:23:04.000Z" title="发表于 2020-10-15 22:23:04">2020-10-15</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/write-up/">write_up</a></span></div><div class="content">前言:在做houseoforange_hitcon_2016时涉及了house_of_orange、unsorted bin attack和FSOP，特此复现一下
解题思路:有三个功能，开堆、编辑；堆只能开四个，大小限制在0x1000，编辑堆中存在堆溢出漏洞，而改程序没有free功能，那么需要靠
house of orange来间接使用free功能

House_of_orange
具体请看CTF-WIKI

malloc申请内存时候检测bin中的chunk是否有符合的chunk，若无则尝试使用topchunk，topchunk无法满足时候会尝试使用sysmalloc申请更多的空间，堆有mmap和brk两种分配方式，让堆以brk形式扩展，topchunk会放入unsortedbin中
伪造topchunk的size的条件

伪造的 size 必须要对齐到内存页
size 要大于 MINSIZE(0x10)
size 要小于之后申请的 chunk size + MINSIZE(0x10)
size 的 prev inuse 位必须为 1

调试过程：首先利用house_of_orange ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/2020/10/12/%E4%BB%8E%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95%E7%9A%84%E5%A0%86%E9%A2%98%E5%AD%A6%E4%B9%A0unlink/" title="从一道简单的堆题学习unlink">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165308.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从一道简单的堆题学习unlink"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/10/12/%E4%BB%8E%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95%E7%9A%84%E5%A0%86%E9%A2%98%E5%AD%A6%E4%B9%A0unlink/" title="从一道简单的堆题学习unlink">从一道简单的堆题学习unlink</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-12T07:30:47.000Z" title="发表于 2020-10-12 15:30:47">2020-10-12</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/pwn/">pwn</a></span></div><div class="content">前言：做堆题刚入门时做的unlink，一直没机会写wp，现在写写wp复习一下
题目：https://www.jarvisoj.com/   
[Xman]level_x64
解题思路:查保护可知got表可写。IDA恢复结构体后发现edit处可以编辑扩展，即在我们编辑的长度上扩展，这样可以造成溢出，我们进行free两个相隔的unsorted bin，然后覆盖第一个free掉的chunk的psize和size，使得泄露出堆的基地址。而malloc后的堆地址会存储在堆头
12345678910New(&quot;a&quot;*0x80)#0New(&quot;a&quot;*0x80)#1New(&quot;a&quot;*0x80)#2New(&quot;a&quot;*0x80)#3New(&quot;a&quot;*0x80)#4Delete(3)Delete(1)Edit(0,&#x27;b&#x27;*0x80+&#x27;e&#x27;*0x10)#覆盖chunk1的psize和size，然后利用list可以泄露出heap_base

同理我们利用这个思路可以再把main_ar ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/2020/10/10/babyheap_0ctf_2017/" title="babyheap_0ctf_2017">     <img class="post_bg" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208170833.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="babyheap_0ctf_2017"></a></div><div class="recent-post-info"><a class="article-title" href="/2020/10/10/babyheap_0ctf_2017/" title="babyheap_0ctf_2017">babyheap_0ctf_2017</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2020-10-10T14:47:34.000Z" title="发表于 2020-10-10 22:47:34">2020-10-10</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox article-meta__icon"></i><a class="article-meta__categories" href="/categories/write-up/">write_up</a></span></div><div class="content">解题思路:保护全开，存在五个功能，Allocate、Fill、Free、Dump，其中Fill存在漏洞，未检查填充长度，存在堆溢出漏洞

申请堆只能申请16个，申请堆的大小最大为4096，既然存在堆溢出，而且溢出大小受用户控制，那么具体思路可以如下：
先申请五个堆，四个fastbin和一个unsorted bin，释放掉#2和#1，这样#2和#1进入fastbin中，#1存放指向#2的地址
12345678Allocate(0x10)#0Allocate(0x10)#1Allocate(0x10)#2Allocate(0x10)#3Allocate(0x80)#4Free(2)Free(1)

而堆是地址对齐的，我们通过溢出#0修改#1地址，低一位字节修改为”\x80”，让fastbin本应指向#2的地址指向#4，并且再次通过溢出#3修改#4的size位，修改为0x21
12Fill(0,&#x27;a&#x27;*0x10+p64(0)+p64(0x21)+&#x27;\x80&#x27;)Fill(3,&#x27;a&#x27;*0x10+p64(0)+p64(0x21))

这时 ...</div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/vn_pwn_simpleHeap92de66ab35ad1d659fae887a6e07e13d_1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Fl0ey</div><div class="author-info__description">pwner</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length_num">13</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length_num">3</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Moniy-Fish" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2549897388@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="sticky_layout"><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">一个很菜的pwn手TAT</div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/07/12-7/" title="ROACTF_2a1"><img src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208165411.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ROACTF_2a1"/></a><div class="content"><a class="title" href="/2020/12/07/12-7/" title="ROACTF_2a1">ROACTF_2a1</a><time datetime="2020-12-07T14:27:33.000Z" title="发表于 2020-12-07 22:27:33">2020-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/29/NCTF2020/" title="NCTF2020"><img src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208191236.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="NCTF2020"/></a><div class="content"><a class="title" href="/2020/11/29/NCTF2020/" title="NCTF2020">NCTF2020</a><time datetime="2020-11-29T13:26:24.000Z" title="发表于 2020-11-29 21:26:24">2020-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/20/HouseOfMuney/" title="House_of_Muney"><img src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208191051.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="House_of_Muney"/></a><div class="content"><a class="title" href="/2020/11/20/HouseOfMuney/" title="House_of_Muney">House_of_Muney</a><time datetime="2020-11-20T07:44:24.000Z" title="发表于 2020-11-20 15:44:24">2020-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/12/%E9%93%81%E4%B8%89pwnWriteup/" title="铁人三项线上赛pwn题"><img src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208164539.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="铁人三项线上赛pwn题"/></a><div class="content"><a class="title" href="/2020/11/12/%E9%93%81%E4%B8%89pwnWriteup/" title="铁人三项线上赛pwn题">铁人三项线上赛pwn题</a><time datetime="2020-11-12T11:37:34.000Z" title="发表于 2020-11-12 19:37:34">2020-11-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/04/free%E6%80%9D%E8%B7%AF/" title="glibc-2.31下double free思路"><img src="https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208164650.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="glibc-2.31下double free思路"/></a><div class="content"><a class="title" href="/2020/11/04/free%E6%80%9D%E8%B7%AF/" title="glibc-2.31下double free思路">glibc-2.31下double free思路</a><time datetime="2020-11-04T07:53:09.000Z" title="发表于 2020-11-04 15:53:09">2020-11-04</time></div></div></div></div></div><div class="card-widget card-categories"><div class="card-content"><div class="item-headline"><i class="fas fa-folder-open"></i><span>分类</span></div><ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/linux-kernel/"><span class="card-category-list-name">linux kernel</span><span class="card-category-list-count">2</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/pwn/"><span class="card-category-list-name">pwn</span><span class="card-category-list-count">2</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/write-up/"><span class="card-category-list-name">write_up</span><span class="card-category-list-count">8</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E5%A4%8D%E7%8E%B0/"><span class="card-category-list-name">复现</span><span class="card-category-list-count">1</span></a></li>
            
            </ul></div></div><div class="card-widget card-tags"><div class="card-content"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Linux%E5%86%85%E6%A0%B8/" style="font-size: 1.3em; color: #99a1ac">Linux内核</a> <a href="/tags/pwn/" style="font-size: 1.5em; color: #99a9bf">pwn</a> <a href="/tags/unlink/" style="font-size: 1.1em; color: #999">unlink</a></div></div></div><div class="card-widget card-archives"><div class="card-content"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/12/"><span class="card-archive-list-date">十二月 2020</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/11/"><span class="card-archive-list-date">十一月 2020</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/10/"><span class="card-archive-list-date">十月 2020</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/09/"><span class="card-archive-list-date">九月 2020</span><span class="card-archive-list-count">3</span></a></li></ul></div></div><div class="card-widget card-webinfo"><div class="card-content"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">13</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2020-12-08T13:51:10.778Z"></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/Moniy-Fish/Myimg@main/20201208171528.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 By Fl0ey</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function subtitleType () {
  if (true) { 
    var typed = new Typed("#subtitle", {
      strings: "人生如逆旅&#44我亦是行人".split(","),
      startDelay: 300,
      typeSpeed: 150,
      loop: false,
      backSpeed: 50
    })
  } else {
    document.getElementById("subtitle").innerHTML = '人生如逆旅&#44我亦是行人'
  }
}

if (true) {
  if (typeof Typed === 'function') subtitleType()
  else $.getScript('https://cdn.jsdelivr.net/npm/typed.js/lib/typed.min.js', subtitleType)
} else {
  subtitleType()
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div></body></html>